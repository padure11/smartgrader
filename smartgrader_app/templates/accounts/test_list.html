{% extends 'base.html' %}
{% load static %}

{% block title %}My Tests - SmartGrader{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/test_list.css' %}">
{% endblock %}

{% block content %}

<div class="test-list-container">
    <div class="test-list-header">
        <h1>Tests</h1>
        <a href="{% url 'test-generator' %}" class="create-test-btn">Create Test</a>
    </div>

    {% if tests_with_stats %}
        <!-- Search and Sort Controls -->
        <div class="test-controls" style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <input type="text"
                       id="search-tests"
                       placeholder="Search tests by title..."
                       style="width: 100%; padding: 12px 15px; border: 1px solid #444; background: #2a2a2a; color: #fff; border-radius: 6px; font-size: 14px; transition: border-color 0.2s;"
                       onfocus="this.style.borderColor='#667eea'"
                       onblur="this.style.borderColor='#444'">
            </div>
            <div>
                <select id="sort-tests"
                        style="padding: 12px 15px; border: 1px solid #444; background: #2a2a2a; color: #fff; border-radius: 6px; font-size: 14px; cursor: pointer;">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="submissions-desc">Most Submissions</option>
                    <option value="average-desc">Highest Average</option>
                </select>
            </div>
        </div>

        <div class="test-grid" id="test-grid">
            {% for item in tests_with_stats %}
                <a href="{% url 'test-detail' item.test.id %}" class="test-card-link">
                    <div class="test-card">
                        <h3>{{ item.test.title }}</h3>
                        {% if item.test.description %}
                            <p>{{ item.test.description|truncatewords:15 }}</p>
                        {% endif %}

                        <!-- Stats -->
                        <div class="stats-box">
                            {% if item.submission_count > 0 %}
                                <div class="stats-row">
                                    <span class="stat-label">Submissions</span>
                                    <span class="stat-value">{{ item.submission_count }}</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">Class Average</span>
                                    <span class="stat-value">{{ item.average_percentage }}%</span>
                                </div>
                                {% if item.latest_submission %}
                                <div class="stat-secondary">
                                    Latest: {{ item.latest_submission.full_name }} ({{ item.latest_submission.percentage }}%)
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="no-stats">No submissions yet</div>
                            {% endif %}
                        </div>

                        <div class="test-meta">
                            <span class="test-meta-item">{{ item.test.num_questions }} questions</span>
                            <span class="test-meta-item">{{ item.test.created_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </a>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-tests">
            <h2>No tests yet</h2>
            <p>Create your first test to get started</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Store all tests data for filtering
window.allTests = [
    {% for item in tests_with_stats %}
    {
        id: {{ item.test.id }},
        title: "{{ item.test.title|escapejs }}",
        description: "{{ item.test.description|default:''|escapejs }}",
        num_questions: {{ item.test.num_questions }},
        created_at: "{{ item.test.created_at|date:'M d, Y' }}",
        created_timestamp: new Date("{{ item.test.created_at.isoformat }}").getTime(),
        submission_count: {{ item.submission_count }},
        average_percentage: {{ item.average_percentage }},
        latest_submission: {% if item.latest_submission %}"{{ item.latest_submission.full_name|escapejs }}"{% else %}null{% endif %},
        latest_percentage: {% if item.latest_submission %}{{ item.latest_submission.percentage }}{% else %}0{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
</script>
<script src="{% static 'js/test_list.js' %}"></script>
{% endblock %}
