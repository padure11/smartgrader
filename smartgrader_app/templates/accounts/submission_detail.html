{% extends 'base.html' %}
{% load static %}

{% block title %}{{ submission.full_name }} - {{ test.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/submission_detail.css' %}">
{% endblock %}

{% block content %}

<div class="submission-container">
    <div class="action-buttons">
        <a href="/tests/{{ test.id }}/" class="btn btn-back">‚Üê Back to Test</a>
    </div>

    <div class="submission-header">
        <div class="student-info">
            <h1>
                <span id="student-name-display">{{ submission.full_name }}</span>
                <button onclick="showEditForm()" class="edit-name-btn" id="edit-name-btn">Edit Name</button>
            </h1>
            <div class="name-edit-form" id="name-edit-form">
                <input type="text" id="first-name-input" placeholder="First Name" value="{{ submission.first_name|default:'' }}">
                <input type="text" id="last-name-input" placeholder="Last Name" value="{{ submission.last_name|default:'' }}">
                <button onclick="saveNameEdit()" class="save-btn">Save</button>
                <button onclick="cancelEdit()" class="cancel-btn">Cancel</button>
            </div>
            <p>Submitted: {{ submission.submitted_at|date:"F d, Y H:i" }}</p>
            <p>Test: {{ test.title }}</p>
        </div>
        <div class="score-badge {% if submission.percentage >= 80 %}excellent{% elif submission.percentage >= 60 %}good{% else %}poor{% endif %}">
            <div class="score">{{ submission.score }}/{{ submission.total_questions }}</div>
            <div class="percentage">{{ submission.percentage }}%</div>
        </div>
    </div>

    {% if submission.image %}
    <div class="scanned-image-section">
        <h2>Scanned Answer Sheet</h2>
        <img src="{{ submission.image.url }}" alt="Scanned test" class="scanned-image">
    </div>
    {% endif %}

    <div class="answers-section">
        <h2>Answer Breakdown</h2>
        {% for detail in answer_details %}
        <div class="answer-card {% if detail.is_correct %}correct{% else %}incorrect{% endif %}">
            <div class="question-header">
                <span class="question-num">Question {{ detail.question_num }}</span>
                <span class="status-badge {% if detail.is_correct %}correct{% else %}incorrect{% endif %}">
                    {% if detail.is_correct %}Correct{% else %}Incorrect{% endif %}
                </span>
            </div>

            <div class="question-text">{{ detail.question_text }}</div>

            <div class="options-grid">
                {% for option in detail.options %}
                <div class="option
                    {% if forloop.counter0 == detail.student_answer and forloop.counter0 == detail.correct_answer %}correct-answer
                    {% elif forloop.counter0 == detail.student_answer %}student-wrong
                    {% elif forloop.counter0 == detail.correct_answer %}correct-answer
                    {% endif %}">
                    <span class="option-label">
                        {% if forloop.counter0 == 0 %}A{% endif %}
                        {% if forloop.counter0 == 1 %}B{% endif %}
                        {% if forloop.counter0 == 2 %}C{% endif %}
                        {% if forloop.counter0 == 3 %}D{% endif %}
                        {% if forloop.counter0 == 4 %}E{% endif %}
                    </span>
                    <span>{{ option }}</span>
                    {% if forloop.counter0 == detail.student_answer and forloop.counter0 != detail.correct_answer %}
                        <span style="margin-left: auto;">Your Answer</span>
                    {% elif forloop.counter0 == detail.correct_answer %}
                        <span style="margin-left: auto;">Correct Answer</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Set global variables for use by external JS
window.testId = {{ test.id }};
window.submissionId = {{ submission.id }};
window.testTitle = "{{ test.title|escapejs }}";
</script>
<script src="{% static 'js/submission_detail.js' %}"></script>
{% endblock %}
