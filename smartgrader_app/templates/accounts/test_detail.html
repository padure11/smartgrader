{% extends 'base.html' %}
{% load static %}

{% block title %}{{ test.title }} - SmartGrader{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/test_detail.css' %}">
{% endblock %}

{% block content %}

<div class="test-detail-container">
    <div id="message" class="message hidden"></div>

    <div class="test-header">
        <h1>
            <span id="test-title-display">{{ test.title }}</span>
            <button onclick="showEditTitleForm()" class="edit-title-btn" id="edit-title-btn">Edit Title</button>
        </h1>
        <div class="title-edit-form" id="title-edit-form">
            <input type="text" id="title-input" placeholder="Test Title" value="{{ test.title }}">
            <button onclick="saveTitleEdit()" class="save-btn">Save</button>
            <button onclick="cancelTitleEdit()" class="cancel-btn">Cancel</button>
        </div>
        {% if test.description %}
            <p style="margin-bottom: 20px; color: #bbb; line-height: 1.5;">{{ test.description }}</p>
        {% endif %}
        <div class="test-meta-info">
            <div class="meta-item">
                <span class="meta-label">Questions:</span>
                <span class="meta-value">{{ test.num_questions }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Options:</span>
                <span class="meta-value">{{ test.num_options }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Created:</span>
                <span class="meta-value">{{ test.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">By:</span>
                <span class="meta-value">{{ test.created_by.email }}</span>
            </div>
        </div>
        <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 2px solid #667eea;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span style="color: #667eea; font-weight: 600; font-size: 14px;">üìù Student Enrollment Code:</span>
                <span id="enrollment-code" style="font-family: monospace; font-size: 20px; color: #69c8a0; font-weight: 700; letter-spacing: 2px;">{{ test.enrollment_code }}</span>
                <button onclick="copyEnrollmentCode()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">Copy Code</button>
                <span style="color: #999; font-size: 13px; font-style: italic;">Share this code with students to let them enroll</span>
            </div>
        </div>
    </div>

    <div class="actions-section">
        <h2>Actions</h2>
        <div class="action-buttons">
            <button onclick="generatePDF()" class="action-btn btn-primary">
                Generate PDF
            </button>
            <button onclick="duplicateTest()" class="action-btn btn-secondary">
                Duplicate Test
            </button>
            <button onclick="showAnalytics()" class="action-btn btn-secondary">
                View Analytics
            </button>
            <button onclick="exportResults()" class="action-btn btn-secondary">
                Export to CSV
            </button>
            <a href="/tests/" class="action-btn btn-back">
                ‚Üê Back to Tests
            </a>
            <button onclick="confirmDelete()" class="action-btn btn-danger">
                Delete Test
            </button>
        </div>
    </div>

    <div class="actions-section" id="analytics-section" style="display: none;">
        <h2>Test Analytics</h2>
        <div id="analytics-content">
            <p style="color: #ccc;">Loading analytics...</p>
        </div>
    </div>

    <div class="actions-section">
        <h2>Upload Submissions</h2>
        <p style="color: #999; margin-bottom: 20px; font-size: 14px;">Upload scanned answer sheets (images or ZIP file) to automatically grade them using OMR</p>

        <div class="upload-area">
            <input type="file" id="image-uploads" multiple accept="image/*" style="display: none;">
            <input type="file" id="zip-upload" accept=".zip" style="display: none;">

            <div class="upload-buttons">
                <button onclick="document.getElementById('image-uploads').click()" class="action-btn btn-secondary">
                    Upload Images
                </button>
                <button onclick="document.getElementById('zip-upload').click()" class="action-btn btn-secondary">
                    Upload ZIP File
                </button>
            </div>

            <div id="upload-status" style="margin-top: 15px; color: #fff;"></div>
        </div>
    </div>

    <div class="actions-section" id="submissions-section">
        <h2>Graded Submissions</h2>

        <!-- Search and Sort Controls -->
        <div class="submissions-controls" style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <input type="text"
                       id="search-submissions"
                       placeholder="Search by name..."
                       style="width: 100%; padding: 10px 15px; border: 1px solid #444; background: #1c1c1c; color: #fff; border-radius: 6px; font-size: 14px; transition: border-color 0.2s;"
                       onfocus="this.style.borderColor='#667eea'"
                       onblur="this.style.borderColor='#444'">
            </div>
            <div>
                <select id="sort-submissions"
                        style="padding: 10px 15px; border: 1px solid #444; background: #1c1c1c; color: #fff; border-radius: 6px; font-size: 14px; cursor: pointer;">
                    <option value="percentage-desc">Highest Score First</option>
                    <option value="percentage-asc">Lowest Score First</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                </select>
            </div>
        </div>

        <div id="submissions-list">
            <p style="color: #ccc;">Loading submissions...</p>
        </div>
    </div>

    <div class="questions-section">
        <h2>Questions & Answers</h2>
        {% for question in test.questions %}
            <div class="question-item">
                <div class="question-number">Question {{ forloop.counter }}</div>
                <div class="question-text">{{ question.question }}</div>
                <ul class="options-list">
                    {% for option in question.options %}
                        <li class="option-item {% if forloop.counter0 == question.correct_answer %}correct{% endif %}">
                            <span class="option-label">
                                {% if forloop.counter0 == 0 %}A{% endif %}
                                {% if forloop.counter0 == 1 %}B{% endif %}
                                {% if forloop.counter0 == 2 %}C{% endif %}
                                {% if forloop.counter0 == 3 %}D{% endif %}
                                {% if forloop.counter0 == 4 %}E{% endif %}
                            </span>
                            <span>{{ option }}</span>
                            {% if forloop.counter0 == question.correct_answer %}
                                <span style="margin-left: auto; color: #69c8a0;">‚úì Correct</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>
</div>

<script>
// Set global variables for use by external JS
window.testId = {{ test.id }};
window.numQuestions = {{ test.num_questions }};
</script>
<script src="{% static 'js/test_detail.js' %}"></script>
{% endblock %}
